# 分布式存储学习笔记

## 目录

- [分布式存储学习笔记](#分布式存储学习笔记)
  - [目录](#目录)
  - [传统物理存储形式](#传统物理存储形式)
    - [DAS](#das)
    - [SAN](#san)
    - [NAS](#nas)
  - [SDS软件定义存储](#sds软件定义存储)
    - [块存储](#块存储)
    - [对象存储](#对象存储)
    - [文件存储](#文件存储)
  - [分布式存储架构](#分布式存储架构)
    - [Ceph](#ceph)
    - [FusionStorage/OceanStor100D](#fusionstorageoceanstor100d)
  - [Ceph存储架构](#ceph存储架构)
    - [多副本与EC](#多副本与ec)
  - [Ceph后端存储](#ceph后端存储)
  - [Ceph部署](#ceph部署)
  - [Ceph与OpenStack集成](#ceph与openstack集成)
  
## 传统物理存储形式

    随着互联网技术的不断进步，主机，磁盘以及网络等也在不断的往前发展，数据的存储方式也在不断的变化，

- 传统物理存储形式主要包括：
  - 内部（直连）存储：

    ```
    顾名思义就是与服务器内部直接相连的磁盘或者是磁盘阵列。可以走的是SATA、SAS等接口或者是NVME等PCIe总线协议。
    ```

  - 外挂存储：
    - `DAS`(Direct-Attached Storage，简称DAS)(其中的外直连存储)
    - `FAS`(Fabric-Attached Storage，简称FAS)
    - <u>二者区别：</u></br>
        DAS可以走服务器内部的总线然后挂载到服务器上，而FAS是走网络通过不同的网络存储协议进行通信。
    - <u>二者比较优劣：</u>
      - DAS优势：中小型企业使用，简单便宜。（详见下文DAS优势）
      - FAS优势：相比较DAS不会过早出现IO瓶颈。
    - FAS：
      - `SAN`(Network-Attached Storage，简称NAS)
      - `NAS`(Network-Attached Storage，简称NAS)

### DAS

    直连式存储顾名思义就是通过电缆（通常是SCSI接口电缆）直接挂到服务器总线上，存储设备只与一台独立的主机连接，其他主机不能使用这个存储设备。
    * 很多博客会将DAS直连和内外直连存储的界限划定的非常模糊。因为都会走服务器对系统总线，占用系统的资源，而我认为分开去界定是十分有必要。
    * 维基百科中是这样定义的：“直连式存储又可分为内直连式存储和外直连式存储。内直连式存储是指存储设备与服务器通过串行或并行SCSI总线接1：3电缆直接集成在一起，但SCSI总线自身有传输距离和挂载设备的限制。外直连式存储通过SCSI或光纤通道将服务器和外部的存储设备直接连接，与内直连式存储相比，外直连式存储可通过光纤通道克服传输距离和挂载设备的限制。对于少量PC机或服务器，使用直连式存储连接简单、易于配置和管理、费用较低，但这种连接方式下，因每台计算机单独拥有自己的存储磁盘，所以不利于存储容量的充分利用和服务器间的数据共享，而且存储系统没有集中统一的管理方案，也不利于数据维护，因此直连式存储不适合作为企业级的存储解决方案。”
    * 拿最简单的个人存储的例子来说，一般来说个人pc都会把系统安装于内置的直连存储上，如果内直连存储因为主板的接口限制而达到上限无法再进行扩容时就会考虑到使用DAS的外直连存储通过SCSI接口或者光纤通道直连pc，更有甚者也可以依靠usb接口来实现存储的扩展。

- 接口和协议：
  - 协议：
    - SCSI协议：
      - SCSI接口
      - SAS接口
    - ATA协议：
      - SATA接口
      - IDE接口(目前已淘汰)
    - FC协议：
      - FC光纤接口
  - 接口：SCSI、SAS、SATA、M.2、PCIe、USB等等
  - SCSI：
  
        (Small Computer System Interface ) 小型计算机系统接口，它分为并行SCSI（内部DAS）和串行ISCSI（外部DAS）使用SCSI是需要安装SCSI适配器通过ASPI的标准软件接口驱动SCSI；单个SCSI适配器的总线可以有8到16个SCSI设备SCSI设备连接。

  - 由图可以看出SCSI通过系统PCI总线进行数据流量的传输。![SCSIBus](img/20210211094341352.png)
  - SCSI协议

        在网络通信中每个层有每个层存在的协议，当协议发送时发送端进行封装，而接送时只有符合条件的才可以执行解封装获得数据。SCSI协议也是一种负责由SCSI设备之间通信相互达成契合的一个约定
        SCSI-3协议架构是由ANSI认可和发布的X.3.270-1996号标准，由三层组成，物理层、传输层、命令层

    - 物理层

      以网络总的物理层相似，通过物理媒介进行连接，约定采用标准范围类的接口，SCSI-3接口，IEEE串行接口，光纤通道。

    - 传输层

      定义了设备间互连和信息共享的标准规则，保障计算机生成的SCSI指令都能够成功的传送到目标端。

    - 命令层

      也称为应用层。它包括了适用于所有设备的通用指令和某一指定类型的设备专用的初级指令。

    - 此处关于SCSI协议更详细内容请参考`原文链接`：https://blog.csdn.net/qq_16544389/article/details/113788480
  - SAS接口(Serail Attached SCSI)

        采用和SATA一样的串行技术，物理接口和SATA非常相似，甚至可以向下兼容SATA标准
        * SAS接口可以向下兼容SATA，但是SATA接口显而易见无法向上兼容SAS硬盘。也就是说SAS的磁盘只能用于SAS接口，而不能用于SATA接口，而SATA的盘可以用于SAS上。
    - 优势
      1. 更好的性能：点到点的技术减少了地址冲突以及菊花链连结的减速；为每个设备提供了专用的信号通路来保证最大的带宽；全双工方式下的数据操作保证最有效的数据吞吐量；
      2. 简便的线缆连结：更细的电缆搭配更小的连接器；
      3. 更好的扩展性：可以同时连结更多的磁盘设备。
  - SATA接口

        SATA硬盘，即SATA（Serial ATA）又被称为串口硬盘。SATA采用差分信号系统，该系统能有效将噪声滤除。支持热插拔。总线使用了嵌入式时钟频率信号，具备了比以往更强的纠错能力，能对传输指令（不仅是数据）进行检查，如果发现错误会自动矫正，提高了数据传输的可靠性。
    - SATA接口结构

      SATA接口使用4根电缆传输数据。Tx+、Tx-表示输出差分数据线，对应的，Rx+、Rx-表示输入差分数据线。

      ![](img/20181023112339568.png)
    - SATA协议模型

      SATA接口协议借鉴TCP/IP模型，将SATA接口划分为四个层次来实现，包括物理层、链路层、传输层、应用层。
      
      ![](img/20181023112354332.png)
      2.2.3 物理层分析

      - 物理层

      采用全双工串行传输方式，主要功能是进行信号的串并及并串转化。物理层接收来自链路层的数据信息，将接收到的并行的数字逻辑信号转换为串行的差分物理信号，发送到主机端。相应的物理层能将来自主机端的串行差分物理信号转化为并行的逻辑信号传送到链路层。为了提高 SATA 接口的扩展能力和响应能力， SATA 协议还引进了带外信号(Out Of Band，OOB)来协助物理层进行上电初始化以及复位操作。

      - 链路层分析链路层的主要功能是通过控制原语的传递来控制信息帧的整个传输过程，保证帧信息能够正确的发送与接收并能进行流量的控制，防止数据发送过快或接受过多。

1）接收来自物理层的信息，对信息帧进行编码、解码、校验和扰码，然后给传输层发送 SOF 原语，通知传输层接收数据，当数据发送完成后，给传输层发送EOF原语，通知传输层该帧传输完成。

2）接收来自传输层的信息，给接收的信息头封装上SOF原语和EOF原语，然后对信息帧进行编码、解码、校验、扰码，传送给物理层。

链路层的控制原语是用来控制和维持串行链路数据传输状态。它们是以32位数据为单位的信息包，控制原语一共有18种，它们都有各自的功能，如：ALIGN原语用来做物理层中数据对齐；SOF、EOF原语用来做数据传输时信息帧的边界定义等。

2.2.5 传输层分析

传输层主要负责FIS帧信息结构的封装与解封。

1）传输层接收到来自应用层的数据传输操作请求后，将相关寄存器中信息按SATA协议规定的标准格式封装为FIS传递给链路层。当链路层正确接收完成后，能给传输层反馈成功完成本次传输的信号。

2）传输层接收到来自链路层的SOF信号后，能接收FIS信息帧，并能判断该FIS的类型，根据FIS类型，判断该FIS是否是有效的FIS。如果是则将该FIS中的命令和数据等按照SATA协议规定进行解析，映射到各个寄存器中，然后能通知应用层接收相应寄存器的值。如果该FIS无效，则丢弃。

2.2.6 应用层分析

应用层能够进行接受来自主机端的命令，根据命令的要求将自身的信息发送给主机端，或是接收来自主机端的以PIO或DMA方式传输的数据,同时写入闪存中，也能从闪存中以PIO或DMA的方式读出数据，传送给主机端。

在应用层采用两个FIFO对数据进行缓冲，一个为读FIFO，一个为写FIFO。应用层能接收来自传输层的数据帧送入写FIFO中或将来自总线的数据保存在读FIFO中，然后通知传输层构造数据帧。
- 优势：
  1. 搭建简单，对应用程序兼容性也比较好。
  2. 传输速度快，如果你的存储系统中需要快速访问，但是公司目前还不能接受最新的SAN技术的价格时或者SAN技术在你的公司中还不是一种必要的技术时，这是一种理想的选择。
  3. 便宜，对于那些对成本非常敏感的客户来说，在很长一段时间内，DAS将仍然是一种比较便宜的存储机制。
  4. 这是被最早采用的存储技术

- 不足：
  1. 只能连接一个服务器，无法从物理层面做到存储共享。
  2. 随着数据量的不断增大，对服务器的cpu要求越来越高。
  3. 扩容比较麻烦，会造成系统的停机。
  4. 无法进行统一的存储管理

- DAS的适用环境为：
  1. 服务器在地理分布上很分散，通过SAN或NAS在它们之间进行互连非常困难时。
  2. 存储系统必须被直接连接到应用服务器(如Microsoft Cluster Server或某些数据库使用的“原始分区”)上时。
  3. 只有单台服务器，存储设备无需与其他服务器共享。适用于单一节点的企业级应用。

### SAN

### NAS

## SDS软件定义存储

### 块存储

### 对象存储

### 文件存储

## 分布式存储架构

### Ceph

### FusionStorage/OceanStor100D

## Ceph存储架构

### 多副本与EC

    在分布式存储系统下的一种数据可靠性保护技术，通过相同的数据在不同的节点上通过副本或是纠删码的方式存储多份数据内容，支持当单点故障情况下，比如节点或者硬盘故障，可以通过读取冗余的数据来实现外部存储请求不中断。无论是多副本或是EC都是在文件切片时发生的一个数据保护过程

## Ceph后端存储

## Ceph部署

## Ceph与OpenStack集成
